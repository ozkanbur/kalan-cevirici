<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stok AyrÄ±ÅŸtÄ±rÄ±cÄ± (Final)</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#28a745">
    
    <script src="xlsx-populate.min.js"></script>
    <script src="FileSaver.min.js"></script>
    
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; padding: 20px; background-color: #f0f2f5; text-align: center; }
        .container { max-width: 600px; margin: 20px auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        h2 { color: #2c3e50; margin-bottom: 10px; }
        p { color: #666; font-size: 14px; }
        .drop-zone { border: 2px dashed #cbd5e0; border-radius: 8px; padding: 30px; margin: 20px 0; background: #f8fafc; cursor: pointer; transition: 0.3s; }
        .drop-zone:hover { border-color: #28a745; background: #f0fff4; }
        input[type=file] { display: none; }
        .upload-btn { background: #28a745; color: white; padding: 10px 20px; border-radius: 5px; cursor: pointer; display: inline-block; font-weight: bold; }
        button#processBtn { background-color: #2c3e50; color: white; border: none; padding: 15px 30px; font-size: 16px; border-radius: 8px; cursor: pointer; width: 100%; margin-top: 10px; transition: 0.3s; }
        button#processBtn:hover { background-color: #34495e; }
        button:disabled { background-color: #bdc3c7; cursor: not-allowed; }
        #log { margin-top: 20px; text-align: left; font-size: 13px; max-height: 250px; overflow-y: auto; background: #2d3436; color: #dfe6e9; padding: 15px; border-radius: 8px; font-family: monospace; }
        .success { color: #00b894; }
        .error { color: #ff7675; }
        .warning { color: #fdcb6e; }
    </style>
</head>
<body>

<div class="container">
    <h2>Stok AyrÄ±ÅŸtÄ±rÄ±cÄ± (HatasÄ±z)</h2>
    <p><b>"Kalan_Stok"</b> sayfasÄ±; stiller bozulmadan ve onarÄ±m hatasÄ± vermeden <b>D5</b> isminde ayrÄ±ÅŸtÄ±rÄ±lacaktÄ±r.</p>
    
    <div class="drop-zone" onclick="document.getElementById('upload').click()">
        <span class="upload-btn">ğŸ“‚ Excel DosyalarÄ±nÄ± SeÃ§</span>
        <input type="file" id="upload" multiple accept=".xlsx, .xls">
        <div style="margin-top:10px; color:#aaa; font-size:12px;" id="fileCount">HenÃ¼z dosya seÃ§ilmedi</div>
    </div>
    
    <button id="processBtn" onclick="processFiles()">Ä°ÅŸlemi BaÅŸlat</button>
    
    <div id="log">Sistem HazÄ±r...</div>
</div>

<script>
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('sw.js').catch(err => console.log('SW HatasÄ±:', err));
        });
    }

    document.getElementById('upload').addEventListener('change', function(){
        document.getElementById('fileCount').innerText = this.files.length + " dosya seÃ§ildi.";
    });

    const delay = ms => new Promise(res => setTimeout(res, ms));

    async function processFiles() {
        const fileInput = document.getElementById('upload');
        const files = fileInput.files;
        const logDiv = document.getElementById('log');
        const btn = document.getElementById('processBtn');

        if (files.length === 0) { alert("LÃ¼tfen dosya seÃ§in!"); return; }
        
        if (typeof XlsxPopulate === 'undefined') {
            logDiv.innerHTML = "<div class='error'>HATA: 'xlsx-populate.min.js' bulunamadÄ±.</div>";
            return;
        }

        btn.disabled = true;
        btn.innerText = "Ä°ÅŸleniyor...";
        logDiv.innerHTML = "";
        
        let processedCount = 0;

        for (let i = 0; i < files.length; i++) {
            const file = files[i];
            logDiv.innerHTML += `<div>â³ ${file.name} iÅŸleniyor...</div>`;

            try {
                // xlsx-populate ile dosyayÄ± aÃ§
                const workbook = await XlsxPopulate.fromDataAsync(file);

                // SayfayÄ± bul (BÃ¼yÃ¼k/kÃ¼Ã§Ã¼k harf duyarsÄ±z)
                let targetSheet = null;
                workbook.sheets().forEach(sheet => {
                    if (sheet.name().toLowerCase() === "kalan_stok") {
                        targetSheet = sheet;
                    }
                });

                if (!targetSheet) {
                    logDiv.innerHTML += `<div class="error">âŒ "Kalan_Stok" bulunamadÄ±: ${file.name}</div>`;
                    continue;
                }

                // D5 hÃ¼cresini oku
                const cellValue = targetSheet.cell("D5").value();
                let targetName = "";

                if (cellValue) {
                     // FormÃ¼l sonucu veya text olabilir, string'e Ã§evir
                    targetName = cellValue.toString().trim();
                } else {
                    targetName = file.name.replace(/\.[^/.]+$/, "") + "_stok";
                    logDiv.innerHTML += `<div class="warning">âš ï¸ D5 boÅŸ, dosya adÄ± kullanÄ±ldÄ±.</div>`;
                }

                // YasaklÄ± karakterleri temizle ve 31 karaktere sÄ±ÄŸdÄ±r
                targetName = targetName.replace(/[<>:"/\\|?*]/g, "_").substring(0, 31);

                // DiÄŸer sayfalarÄ± sil
                const sheetsToDelete = [];
                workbook.sheets().forEach(sheet => {
                    if (sheet.name() !== targetSheet.name()) {
                        sheetsToDelete.push(sheet);
                    }
                });

                // Silme iÅŸlemi
                sheetsToDelete.forEach(sheet => sheet.delete());

                // Kalan sayfanÄ±n adÄ±nÄ± deÄŸiÅŸtir
                targetSheet.name(targetName);

                // DosyayÄ± Blob olarak oluÅŸtur
                const blob = await workbook.outputAsync();

                // Ä°ndir
                saveAs(blob, targetName + ".xlsx");
                
                logDiv.innerHTML += `<div class="success">âœ… TamamlandÄ±: ${targetName}.xlsx</div>`;
                processedCount++;

                await delay(500);

            } catch (err) {
                console.error(err);
                logDiv.innerHTML += `<div class="error">âš ï¸ Hata: ${file.name} - ${err.message}</div>`;
            }
        }

        btn.disabled = false;
        btn.innerText = "Tekrar Ä°ÅŸlem Yap";
        
        if (processedCount > 0) {
            logDiv.innerHTML += `<div style="color:#00b894; font-weight:bold; margin-top:10px;">ğŸ‰ TÃ¼m Ä°ÅŸlemler Bitti!</div>`;
        }
    }
</script>

</body>
</html>