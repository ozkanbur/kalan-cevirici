<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stok AyrÄ±ÅŸtÄ±rÄ±cÄ±</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#28a745">
    
    <script src="xlsx.full.min.js"></script>
    <script src="jszip.min.js"></script>
    <script src="FileSaver.min.js"></script>
    
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; padding: 20px; background-color: #f0f2f5; text-align: center; }
        .container { max-width: 600px; margin: 20px auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        h2 { color: #2c3e50; margin-bottom: 10px; }
        p { color: #666; font-size: 14px; }
        .drop-zone { border: 2px dashed #cbd5e0; border-radius: 8px; padding: 30px; margin: 20px 0; background: #f8fafc; cursor: pointer; transition: 0.3s; }
        .drop-zone:hover { border-color: #28a745; background: #f0fff4; }
        input[type=file] { display: none; }
        .upload-btn { background: #28a745; color: white; padding: 10px 20px; border-radius: 5px; cursor: pointer; display: inline-block; font-weight: bold; }
        button#processBtn { background-color: #2c3e50; color: white; border: none; padding: 15px 30px; font-size: 16px; border-radius: 8px; cursor: pointer; width: 100%; margin-top: 10px; transition: 0.3s; }
        button#processBtn:hover { background-color: #34495e; }
        button:disabled { background-color: #bdc3c7; cursor: not-allowed; }
        #log { margin-top: 20px; text-align: left; font-size: 13px; max-height: 250px; overflow-y: auto; background: #2d3436; color: #dfe6e9; padding: 15px; border-radius: 8px; font-family: monospace; }
        .success { color: #00b894; }
        .error { color: #ff7675; }
        .info { color: #74b9ff; }
    </style>
</head>
<body>

<div class="container">
    <h2>Stok SayfasÄ± AyrÄ±ÅŸtÄ±rÄ±cÄ±</h2>
    <p>DosyalarÄ± seÃ§in. Sistem <b>"Kalan_Stok"</b> sayfasÄ±nÄ± bulup, <b>D5</b> hÃ¼cresindeki isme gÃ¶re ayÄ±racaktÄ±r.</p>
    
    <div class="drop-zone" onclick="document.getElementById('upload').click()">
        <span class="upload-btn">ğŸ“‚ Excel DosyalarÄ±nÄ± SeÃ§</span>
        <input type="file" id="upload" multiple accept=".xlsx, .xls">
        <div style="margin-top:10px; color:#aaa; font-size:12px;" id="fileCount">HenÃ¼z dosya seÃ§ilmedi</div>
    </div>
    
    <button id="processBtn" onclick="processFiles()">Ä°ÅŸlemi BaÅŸlat ve ZIP Ä°ndir</button>
    
    <div id="log">Logs...</div>
</div>

<script>
    // --- PWA (Service Worker) KaydÄ± ---
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('sw.js')
                .then(reg => console.log('Service Worker kayÄ±tlÄ±.', reg.scope))
                .catch(err => console.log('Service Worker hatasÄ±:', err));
        });
    }

    // Dosya seÃ§ildiÄŸinde sayÄ±sÄ±nÄ± gÃ¶ster
    document.getElementById('upload').addEventListener('change', function(){
        document.getElementById('fileCount').innerText = this.files.length + " dosya seÃ§ildi.";
    });

    async function processFiles() {
        const fileInput = document.getElementById('upload');
        const files = fileInput.files;
        const logDiv = document.getElementById('log');
        const btn = document.getElementById('processBtn');

        if (files.length === 0) { alert("LÃ¼tfen dosya seÃ§in!"); return; }
        
        // KÃ¼tÃ¼phane kontrolÃ¼
        if (typeof XLSX === 'undefined') {
            logDiv.innerHTML = "<div class='error'>HATA: KÃ¼tÃ¼phane dosyalarÄ± bulunamadÄ± (xlsx.full.min.js vb.). LÃ¼tfen dosyalarÄ±n klasÃ¶rde olduÄŸundan emin olun.</div>";
            return;
        }

        btn.disabled = true;
        btn.innerText = "Ä°ÅŸleniyor...";
        logDiv.innerHTML = "";
        
        const zip = new JSZip();
        let processedCount = 0;

        for (let i = 0; i < files.length; i++) {
            const file = files[i];
            logDiv.innerHTML += `<div>â³ ${file.name} okunuyor...</div>`;

            try {
                const arrayBuffer = await file.arrayBuffer();
                const workbook = XLSX.read(arrayBuffer, { type: 'array' });

                // GÃœNCELLEME BURADA: Sayfa AdÄ± "Kalan_Stok"
                let sheetName = "Kalan_Stok";
                if (!workbook.Sheets[sheetName]) {
                    // Belki kÃ¼Ã§Ã¼k harfle yazÄ±lmÄ±ÅŸtÄ±r diye kontrol (Opsiyonel)
                    sheetName = Object.keys(workbook.Sheets).find(n => n.toLowerCase() === "kalan_stok");
                }

                if (!workbook.Sheets[sheetName]) {
                    logDiv.innerHTML += `<div class="error">âŒ "Kalan_Stok" sayfasÄ± yok: ${file.name}</div>`;
                    continue;
                }

                const sheet = workbook.Sheets[sheetName];
                
                // GÃœNCELLEME BURADA: HÃ¼cre AdÄ± "D5"
                const cellAddress = "D5"; 
                const cell = sheet[cellAddress];
                
                let targetName = "";
                if (cell && cell.v) {
                    targetName = cell.v.toString().trim();
                } 

                // EÄŸer D5 boÅŸsa dosya adÄ±nÄ±n sonuna _stok ekle
                if (!targetName) {
                    targetName = file.name.replace(/\.[^/.]+$/, "") + "_stok";
                    logDiv.innerHTML += `<div class="info">â„¹ï¸ D5 boÅŸ, dosya adÄ± kullanÄ±ldÄ±.</div>`;
                }

                // Dosya adÄ±nda yasaklÄ± karakterleri temizle
                targetName = targetName.replace(/[<>:"/\\|?*]/g, "_");

                // Yeni Kitap OluÅŸtur
                const newWb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(newWb, sheet, sheetName);
                
                // DosyayÄ± oluÅŸtur ve Zipe ekle
                const wbOut = XLSX.write(newWb, { bookType: 'xlsx', type: 'array' });
                zip.file(targetName + ".xlsx", wbOut);
                
                logDiv.innerHTML += `<div class="success">âœ… Eklendi: ${targetName}.xlsx</div>`;
                processedCount++;

            } catch (err) {
                console.error(err);
                logDiv.innerHTML += `<div class="error">âš ï¸ Hata: ${file.name} - ${err.message}</div>`;
            }
        }

        if (processedCount > 0) {
            logDiv.innerHTML += `<div style="color:yellow; margin-top:10px;">ğŸ“¦ SÄ±kÄ±ÅŸtÄ±rÄ±lÄ±yor...</div>`;
            zip.generateAsync({ type: "blob" }).then(function(content) {
                saveAs(content, "Ayristirilmis_Stoklar.zip");
                logDiv.innerHTML += `<div class="success" style="font-weight:bold; font-size:14px;">ğŸ‰ Ä°ÅLEM TAMAMLANDI! Ä°ndiriliyor...</div>`;
                btn.disabled = false;
                btn.innerText = "Tekrar Ä°ÅŸlem Yap";
            });
        } else {
            logDiv.innerHTML += `<div class="error">HiÃ§bir uygun dosya bulunamadÄ±.</div>`;
            btn.disabled = false;
            btn.innerText = "Tekrar Dene";
        }
    }
</script>

</body>
</html>
