<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stok AyrÄ±ÅŸtÄ±rÄ±cÄ± (PRO Mod)</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#28a745">
    
    <script src="exceljs.min.js"></script>
    <script src="FileSaver.min.js"></script>
    
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; padding: 20px; background-color: #f0f2f5; text-align: center; }
        .container { max-width: 600px; margin: 20px auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        h2 { color: #2c3e50; margin-bottom: 10px; }
        p { color: #666; font-size: 14px; }
        .drop-zone { border: 2px dashed #cbd5e0; border-radius: 8px; padding: 30px; margin: 20px 0; background: #f8fafc; cursor: pointer; transition: 0.3s; }
        .drop-zone:hover { border-color: #28a745; background: #f0fff4; }
        input[type=file] { display: none; }
        .upload-btn { background: #28a745; color: white; padding: 10px 20px; border-radius: 5px; cursor: pointer; display: inline-block; font-weight: bold; }
        button#processBtn { background-color: #2c3e50; color: white; border: none; padding: 15px 30px; font-size: 16px; border-radius: 8px; cursor: pointer; width: 100%; margin-top: 10px; transition: 0.3s; }
        button#processBtn:hover { background-color: #34495e; }
        button:disabled { background-color: #bdc3c7; cursor: not-allowed; }
        #log { margin-top: 20px; text-align: left; font-size: 13px; max-height: 250px; overflow-y: auto; background: #2d3436; color: #dfe6e9; padding: 15px; border-radius: 8px; font-family: monospace; }
        .success { color: #00b894; }
        .error { color: #ff7675; }
        .warning { color: #fdcb6e; }
    </style>
</head>
<body>

<div class="container">
    <h2>Stok AyrÄ±ÅŸtÄ±rÄ±cÄ± (PRO)</h2>
    <p><b>"Kalan_Stok"</b> sayfasÄ±; renkler, kenarlÄ±klar ve formÃ¼ller bozulmadan <b>D5</b> isminde ayrÄ±ÅŸtÄ±rÄ±lacaktÄ±r.</p>
    
    <div class="drop-zone" onclick="document.getElementById('upload').click()">
        <span class="upload-btn">ğŸ“‚ Excel DosyalarÄ±nÄ± SeÃ§</span>
        <input type="file" id="upload" multiple accept=".xlsx, .xls">
        <div style="margin-top:10px; color:#aaa; font-size:12px;" id="fileCount">HenÃ¼z dosya seÃ§ilmedi</div>
    </div>
    
    <button id="processBtn" onclick="processFiles()">Ä°ÅŸlemi BaÅŸlat</button>
    
    <div id="log">Sistem HazÄ±r...</div>
</div>

<script>
    // --- PWA KaydÄ± ---
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('sw.js').catch(err => console.log('SW HatasÄ±:', err));
        });
    }

    document.getElementById('upload').addEventListener('change', function(){
        document.getElementById('fileCount').innerText = this.files.length + " dosya seÃ§ildi.";
    });

    const delay = ms => new Promise(res => setTimeout(res, ms));

    async function processFiles() {
        const fileInput = document.getElementById('upload');
        const files = fileInput.files;
        const logDiv = document.getElementById('log');
        const btn = document.getElementById('processBtn');

        if (files.length === 0) { alert("LÃ¼tfen dosya seÃ§in!"); return; }
        
        // ExcelJS KÃ¼tÃ¼phane KontrolÃ¼
        if (typeof ExcelJS === 'undefined') {
            logDiv.innerHTML = "<div class='error'>HATA: 'exceljs.min.js' bulunamadÄ±. LÃ¼tfen klasÃ¶rÃ¼ kontrol edin.</div>";
            return;
        }

        btn.disabled = true;
        btn.innerText = "Ä°ÅŸleniyor...";
        logDiv.innerHTML = "";
        
        let processedCount = 0;

        for (let i = 0; i < files.length; i++) {
            const file = files[i];
            logDiv.innerHTML += `<div>â³ ${file.name} okunuyor...</div>`;

            try {
                const arrayBuffer = await file.arrayBuffer();
                
                // ExcelJS ile dosyayÄ± yÃ¼kle (Stilleri korur)
                const workbook = new ExcelJS.Workbook();
                await workbook.xlsx.load(arrayBuffer);

                // "Kalan_Stok" sayfasÄ±nÄ± bul
                let targetSheet = null;
                workbook.eachSheet((sheet, id) => {
                    if (sheet.name.toLowerCase() === "kalan_stok") {
                        targetSheet = sheet;
                    }
                });

                if (!targetSheet) {
                    logDiv.innerHTML += `<div class="error">âŒ "Kalan_Stok" bulunamadÄ±: ${file.name}</div>`;
                    continue;
                }

                // D5 hÃ¼cresindeki veriyi gÃ¼venli al
                const d5Cell = targetSheet.getCell('D5');
                let targetName = "";

                // ExcelJS'de hÃ¼cre deÄŸeri nesne olabilir (formÃ¼l, rich text vs.)
                if (d5Cell.value) {
                    if (typeof d5Cell.value === 'object' && d5Cell.value.result) {
                        targetName = d5Cell.value.result.toString(); // FormÃ¼l sonucu
                    } else if (typeof d5Cell.value === 'object' && d5Cell.value.richText) {
                         // Zengin metin ise dÃ¼z metne Ã§evir
                        targetName = d5Cell.value.richText.map(t => t.text).join('');
                    } else {
                        targetName = d5Cell.value.toString(); // DÃ¼z veri
                    }
                }

                // D5 boÅŸsa dosya adÄ±nÄ± kullan
                if (!targetName || targetName.trim() === "") {
                    targetName = file.name.replace(/\.[^/.]+$/, "") + "_stok";
                    logDiv.innerHTML += `<div class="warning">âš ï¸ D5 boÅŸ, dosya adÄ± kullanÄ±ldÄ±.</div>`;
                }

                // YasaklÄ± karakterleri temizle
                targetName = targetName.trim().replace(/[<>:"/\\|?*]/g, "_").substring(0, 31);

                // DiÄŸer sayfalarÄ± sil
                // Not: ExcelJS'de dÃ¶ngÃ¼ iÃ§indeyken silmek index hatasÄ± verebilir, Ã¶nce ID'leri topluyoruz.
                const sheetsToRemove = [];
                workbook.eachSheet((sheet, id) => {
                    if (sheet.name !== targetSheet.name) {
                        sheetsToRemove.push(sheet.id);
                    }
                });

                sheetsToRemove.forEach(id => {
                    const sheet = workbook.getWorksheet(id);
                    if(sheet) workbook.removeWorksheet(sheet.id);
                });

                // Kalan sayfanÄ±n adÄ±nÄ± gÃ¼ncelle
                targetSheet.name = targetName;

                // GÃ¶rÃ¼nÃ¼m ayarlarÄ±nÄ± sÄ±fÄ±rla (Bozuk dosya hatasÄ±nÄ± engeller)
                workbook.views = [
                    {
                        x: 0, y: 0, width: 10000, height: 20000,
                        firstSheet: 0, activeTab: 0, visibility: 'visible'
                    }
                ];

                // DosyayÄ± oluÅŸtur (Buffer olarak)
                const buffer = await workbook.xlsx.writeBuffer();
                
                // DosyayÄ± indir
                const blob = new Blob([buffer], { type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" });
                saveAs(blob, targetName + ".xlsx");
                
                logDiv.innerHTML += `<div class="success">âœ… BaÅŸarÄ±lÄ±: ${targetName}.xlsx</div>`;
                processedCount++;

                await delay(500); // TarayÄ±cÄ±yÄ± beklet

            } catch (err) {
                console.error(err);
                logDiv.innerHTML += `<div class="error">âš ï¸ Hata: ${file.name} - ${err.message}</div>`;
            }
        }

        btn.disabled = false;
        btn.innerText = "Tekrar Ä°ÅŸlem Yap";
        
        if (processedCount > 0) {
            logDiv.innerHTML += `<div style="color:#00b894; font-weight:bold; margin-top:10px;">ğŸ‰ Ä°ÅŸlem TamamlandÄ±!</div>`;
        }
    }
</script>

</body>
</html>